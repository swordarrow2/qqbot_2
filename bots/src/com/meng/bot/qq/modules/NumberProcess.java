package com.meng.bot.qq.modules;

import com.meng.bot.annotation.CommandDescribe;
import com.meng.bot.config.Functions;
import com.meng.bot.qq.BaseModule;
import com.meng.bot.qq.BotWrapper;
import com.meng.bot.qq.handler.group.IGroupMessageEvent;
import com.meng.tools.normal.TextLexer;
import net.mamoe.mirai.event.events.GroupMessageEvent;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.Map;

/**
 * @author: 司徒灵羽
 **/
public class NumberProcess extends BaseModule implements IGroupMessageEvent {

    public NumberProcess(BotWrapper botHelper) {
        super(botHelper);
    }

    @Override
    public String getModuleName() {
        return "数字计算";
    }

    @Override
    @CommandDescribe(cmd = ".int 表达式", note = "int数字计算")
    public boolean onGroupMessage(GroupMessageEvent gme) {
        long groupId = gme.getGroup().getId();
        if (!configManager.getGroupConfig(gme.getGroup()).isFunctionEnabled(Functions.NumberProcess)) {
            return false;
        }
        String msg = gme.getMessage().contentToString();
        if (msg.charAt(0) != '.') {
            return false;
        }
        ArrayList<String> list = TextLexer.analyze(msg);
        Iterator<String> iter = list.iterator();
        iter.next();//.
        String next = iter.next();
        if (next.equals("int")) {
            try {
                String firstArg = iter.next();
                if (firstArg.equals("~")) {
                    sendGroupMessage(groupId, "result:" + (~Integer.parseInt(iter.next())));
                    return true;
                }
                int a1 = Integer.parseInt(firstArg);
                String op = iter.next();
                int a2 = Integer.parseInt(iter.next());
                String resu = switch (op) {
                    case "+" -> "result:" + (a1 + a2);
                    case "-" -> "result:" + (a1 - a2);
                    case "*" -> "result:" + (a1 * a2);
                    case "/" -> "result:" + (a1 / a2);
                    case ">>" -> "result:" + (a1 >> a2);
                    case ">>>" -> "result:" + (a1 >>> a2);
                    case "<<" -> "result:" + (a1 << a2);
                    case "^" -> "result:" + (a1 ^ a2);
                    case "%" -> "result:" + (a1 % a2);
                    case "|" -> "result:" + (a1 | a2);
                    case "&" -> "result:" + (a1 & a2);
                    default -> "failed";
                };
                sendGroupMessage(groupId, resu);
            } catch (Exception e) {
                sendGroupMessage(groupId, e.toString());
            }
            return true;
        } else if (next.equals("homo")) {
            long sub = Long.parseLong(iter.next());
            StringBuilder builder = new StringBuilder();
            for (Map.Entry<Integer, String> entry : dictionary.entrySet()) {
                int minu = entry.getKey();
                if (sub - minu >= 0) {
                    String value = entry.getValue();
                    builder.append("(").append(value).append(")+");
                    sub = sub - minu;
                }
            }
            builder.setLength(builder.length() - 1);
            sendGroupMessage(groupId, builder.toString());
            return true;
        }
        return false;
    }

    private final Map<Integer, String> dictionary = new LinkedHashMap<>() {
        {
            put(114514, "114514");
            put(58596, "114*514");
            put(49654, "11*4514");
            put(45804, "11451*4");
            put(23256, "114*51*4");
            put(22616, "11*4*514");
            put(19844, "11*451*4");
            put(16030, "1145*14");
            put(14515, "1+14514");
            put(14514, "1*14514");
            put(14513, "-1+14514");
            put(11455, "11451+4");
            put(11447, "11451-4");
            put(9028, "(1+1)*4514");
            put(8976, "11*4*51*4");
            put(7980, "114*5*14");
            put(7710, "(1+14)*514");
            put(7197, "1+14*514");
            put(7196, "1*14*514");
            put(7195, "-1+14*514");
            put(6930, "11*45*14");
            put(6682, "(1-14)*-514");
            put(6270, "114*(51+4)");
            put(5818, "114*51+4");
            put(5810, "114*51-4");
            put(5808, "(1+1451)*4");
            put(5805, "1+1451*4");
            put(5804, "1*1451*4");
            put(5803, "-1+1451*4");
            put(5800, "(1-1451)*-4");
            put(5725, "1145*(1+4)");
            put(5698, "11*(4+514)");
            put(5610, "-11*(4-514)");
            put(5358, "114*(51-4)");
            put(5005, "11*(451+4)");
            put(4965, "11*451+4");
            put(4957, "11*451-4");
            put(4917, "11*(451-4)");
            put(4584, "(1145+1)*4");
            put(4580, "1145*1*4");
            put(4576, "(1145-1)*4");
            put(4525, "11+4514");
            put(4516, "1+1+4514");
            put(4515, "1+1*4514");
            put(4514, "1-1+4514");
            put(4513, "-1*1+4514");
            put(4512, "-1-1+4514");
            put(4503, "-11+4514");
            put(4112, "(1+1)*4*514");
            put(3608, "(1+1)*451*4");
            put(3598, "(11-4)*514");
            put(3435, "-1145*(1-4)");
            put(3080, "11*4*5*14");
            put(3060, "(11+4)*51*4");
            put(2857, "1+14*51*4");
            put(2856, "1*14*51*4");
            put(2855, "-1+14*51*4");
            put(2850, "114*5*(1+4)");
            put(2736, "114*(5+1)*4");
            put(2652, "(1-14)*51*-4");
            put(2570, "1*(1+4)*514");
            put(2475, "11*45*(1+4)");
            put(2420, "11*4*(51+4)");
            put(2280, "114*5*1*4");
            put(2248, "11*4*51+4");
            put(2240, "11*4*51-4");
            put(2166, "114*(5+14)");
            put(2068, "11*4*(51-4)");
            put(2067, "11+4*514");
            put(2058, "1+1+4*514");
            put(2057, "1/1+4*514");
            put(2056, "1/1*4*514");
            put(2055, "-1/1+4*514");
            put(2054, "-1-1+4*514");
            put(2045, "-11+4*514");
            put(2044, "(1+145)*14");
            put(2031, "1+145*14");
            put(2030, "1*145*14");
            put(2029, "-1+145*14");
            put(2024, "11*(45+1)*4");
            put(2016, "-(1-145)*14");
            put(1980, "11*45*1*4");
            put(1936, "11*(45-1)*4");
            put(1848, "(11+451)*4");
            put(1824, "114*(5-1)*4");
            put(1815, "11+451*4");
            put(1808, "1*(1+451)*4");
            put(1806, "1+1+451*4");
            put(1805, "1+1*451*4");
            put(1804, "1-1+451*4");
            put(1803, "1*-1+451*4");
            put(1802, "-1-1+451*4");
            put(1800, "1*-(1-451)*4");
            put(1793, "-11+451*4");
            put(1760, "-(11-451)*4");
            put(1710, "114*-5*(1-4)");
            put(1666, "(114+5)*14");
            put(1632, "(1+1)*4*51*4");
            put(1542, "1*-(1-4)*514");
            put(1526, "(114-5)*14");
            put(1485, "11*-45*(1-4)");
            put(1456, "1+1451+4");
            put(1455, "1*1451+4");
            put(1454, "-1+1451+4");
            put(1448, "1+1451-4");
            put(1447, "1*1451-4");
            put(1446, "-1+1451-4");
            put(1428, "(11-4)*51*4");
            put(1386, "11*(4+5)*14");
            put(1260, "(1+1)*45*14");
            put(1159, "1145+14");
            put(1150, "1145+1+4");
            put(1149, "1145+1*4");
            put(1148, "1145-1+4");
            put(1142, "1145+1-4");
            put(1141, "1145-1*4");
            put(1140, "(1145-1)-4");
            put(1131, "1145-14");
            put(1100, "11*4*5*(1+4)");
            put(1056, "11*4*(5+1)*4");
            put(1050, "(11+4)*5*14");
            put(1036, "(1+1)*(4+514)");
            put(1026, "114*-(5-14)");
            put(1020, "1*(1+4)*51*4");
            put(981, "1+14*5*14");
            put(980, "1*14*5*14");
            put(979, "-1+14*5*14");
            put(910, "-(1-14)*5*14");
            put(906, "(1+1)*451+4");
            put(898, "(1+1)*451-4");
            put(894, "(1+1)*(451-4)");
            put(880, "11*4*5*1*4");
            put(836, "11*4*(5+14)");
            put(827, "11+4*51*4");
            put(825, "(11+4)*(51+4)");
            put(818, "1+1+4*51*4");
            put(817, "1*1+4*51*4");
            put(816, "1*1*4*51*4");
            put(815, "-1+1*4*51*4");
            put(814, "-1-1+4*51*4");
            put(805, "-11+4*51*4");
            put(784, "(11+45)*14");
            put(771, "1+14*(51+4)");
            put(770, "1*14*(51+4)");
            put(769, "(11+4)*51+4");
            put(761, "(1+14)*51-4");
            put(730, "(1+145)*(1+4)");
            put(726, "1+145*(1+4)");
            put(725, "1*145*(1+4)");
            put(724, "-1-145*-(1+4)");
            put(720, "(1-145)*-(1+4)");
            put(719, "1+14*51+4");
            put(718, "1*14*51+4");
            put(717, "-1-14*-51+4");
            put(715, "(1-14)*-(51+4)");
            put(711, "1+14*51-4");
            put(710, "1*14*51-4");
            put(709, "-1+14*51-4");
            put(705, "(1+14)*(51-4)");
            put(704, "11*4*(5-1)*4");
            put(688, "114*(5+1)+4");
            put(680, "114*(5+1)-4");
            put(667, "-(1-14)*51+4");
            put(660, "(114+51)*4");
            put(659, "1+14*(51-4)");
            put(658, "1*14*(51-4)");
            put(657, "-1+14*(51-4)");
            put(649, "11*(45+14)");
            put(644, "1*(1+45)*14");
            put(641, "11+45*14");
            put(632, "1+1+45*14");
            put(631, "1*1+45*14");
            put(630, "1*1*45*14");
            put(629, "1*-1+45*14");
            put(628, "114+514");
            put(619, "-11+45*14");
            put(616, "1*-(1-45)*14");
            put(612, "-1*(1-4)*51*4");
            put(611, "(1-14)*-(51-4)");
            put(609, "11*(4+51)+4");
            put(601, "11*(4+51)-4");
            put(595, "(114+5)*(1+4)");
            put(584, "114*5+14");
            put(581, "1+145*1*4");
            put(580, "1*145/1*4");
            put(579, "-1+145*1*4");
            put(576, "1*(145-1)*4");
            put(575, "114*5+1+4");
            put(574, "114*5/1+4");
            put(573, "114*5-1+4");
            put(567, "114*5+1-4");
            put(566, "114*5*1-4");
            put(565, "114*5-1-4");
            put(561, "11/4*51*4");
            put(560, "(1+1)*4*5*14");
            put(558, "11*4+514");
            put(556, "114*5-14");
            put(545, "(114-5)*(1+4)");
            put(529, "1+14+514");
            put(528, "1*14+514");
            put(527, "-1+14+514");
            put(522, "(1+1)*4+514");
            put(521, "11-4+514");
            put(520, "1+1+4+514");
            put(519, "1+1*4+514");
            put(518, "1-1+4+514");
            put(517, "-1+1*4+514");
            put(516, "-1-1+4+514");
            put(514, "(1-1)/4+514");
            put(513, "-11*(4-51)-4");
            put(512, "1+1-4+514");
            put(511, "1*1-4+514");
            put(510, "1-1-4+514");
            put(509, "11*45+14");
            put(508, "-1-1-4+514");
            put(507, "-11+4+514");
            put(506, "-(1+1)*4+514");
            put(502, "11*(45+1)-4");
            put(501, "1-14+514");
            put(500, "11*45+1+4");
            put(499, "11*45*1+4");
            put(498, "11*45-1+4");
            put(495, "11*(4+5)*(1+4)");
            put(492, "11*45+1-4");
            put(491, "11*45-1*4");
            put(490, "11*45-1-4");
            put(488, "11*(45-1)+4");
            put(481, "11*45-14");
            put(480, "11*(45-1)-4");
            put(476, "(114+5)/1*4");
            put(470, "-11*4+514");
            put(466, "11+451+4");
            put(460, "114*(5-1)+4");
            put(458, "11+451-4");
            put(457, "1+1+451+4");
            put(456, "1*1+451+4");
            put(455, "1-1+451+4");
            put(454, "-1+1*451+4");
            put(453, "-1-1+451+4");
            put(452, "114*(5-1)-4");
            put(450, "(1+1)*45*(1+4)");
            put(449, "1+1+451-4");
            put(448, "1+1*451-4");
            put(447, "1/1*451-4");
            put(446, "1*-1+451-4");
            put(445, "-1-1+451-4");
            put(444, "-11+451+4");
            put(440, "(1+1)*4*(51+4)");
            put(438, "(1+145)*-(1-4)");
            put(436, "-11+451-4");
            put(435, "-1*145*(1-4)");
            put(434, "-1-145*(1-4)");
            put(432, "(1-145)*(1-4)");
            put(412, "(1+1)*4*51+4");
            put(404, "(1+1)*4*51-4");
            put(400, "-114+514");
            put(396, "11*4*-(5-14)");
            put(385, "(11-4)*(51+4)");
            put(376, "(1+1)*4*(51-4)");
            put(375, "(1+14)*5*(1+4)");
            put(368, "(1+1)*(45+1)*4");
            put(363, "(1+1451)/4");
            put(361, "(11-4)*51+4");
            put(360, "(1+1)*45*1*4");
            put(357, "(114+5)*-(1-4)");
            put(353, "(11-4)*51-4");
            put(352, "(1+1)*(45-1)*4");
            put(351, "1+14*-5*-(1+4)");
            put(350, "1*(1+4)*5*14");
            put(349, "-1+14*5*(1+4)");
            put(341, "11*(45-14)");
            put(337, "1-14*-(5+1)*4");
            put(336, "1*14*(5+1)*4");
            put(335, "-1+14*(5+1)*4");
            put(329, "(11-4)*(51-4)");
            put(327, "-(114-5)*(1-4)");
            put(325, "-(1-14)*5*(1+4)");
            put(318, "114+51*4");
            put(312, "(1-14)*-(5+1)*4");
            put(300, "(11+4)*5/1*4");
            put(297, "-11*(4+5)*(1-4)");
            put(291, "11+4*5*14");
            put(286, "(1145-1)/4");
            put(285, "(11+4)*(5+14)");
            put(282, "1+1+4*5*14");
            put(281, "1+14*5/1*4");
            put(280, "1-1+4*5*14");
            put(279, "1*-1+4*5*14");
            put(278, "-1-1+4*5*14");
            put(275, "1*(1+4)*(51+4)");
            put(270, "(1+1)*45*-(1-4)");
            put(269, "-11+4*5*14");
            put(268, "11*4*(5+1)+4");
            put(267, "1+14*(5+14)");
            put(266, "1*14*(5+14)");
            put(265, "-1+14*(5+14)");
            put(260, "1*(14+51)*4");
            put(259, "1*(1+4)*51+4");
            put(257, "(1+1)/4*514");
            put(252, "(114-51)*4");
            put(251, "1*-(1+4)*-51-4");
            put(248, "11*4+51*4");
            put(247, "-(1-14)*(5+14)");
            put(240, "(11+4)*(5-1)*4");
            put(236, "11+45*(1+4)");
            put(235, "1*(1+4)*(51-4)");
            put(234, "11*4*5+14");
            put(231, "11+4*(51+4)");
            put(230, "1*(1+45)*(1+4)");
            put(229, "1145/(1+4)");
            put(227, "1+1+45*(1+4)");
            put(226, "1*1+45*(1+4)");
            put(225, "11*4*5+1+4");
            put(224, "11*4*5/1+4");
            put(223, "11*4*5-1+4");
            put(222, "1+1+4*(51+4)");
            put(221, "1/1+4*(51+4)");
            put(220, "1*1*(4+51)*4");
            put(219, "1+14+51*4");
            put(218, "1*14+51*4");
            put(217, "11*4*5+1-4");
            put(216, "11*4*5-1*4");
            put(215, "11*4*5-1-4");
            put(214, "-11+45*(1+4)");
            put(212, "(1+1)*4+51*4");
            put(211, "11-4+51*4");
            put(210, "1+1+4+51*4");
            put(209, "1+1*4*51+4");
            put(208, "1*1*4+51*4");
            put(207, "-1+1*4*51+4");
            put(206, "11*4*5-14");
            put(204, "(1-1)/4+51*4");
            put(202, "1+1-4+51*4");
            put(201, "1/1-4+51*4");
            put(200, "1/1*4*51-4");
            put(199, "1*-1+4*51-4");
            put(198, "-1-1+4*51-4");
            put(197, "-11+4+51*4");
            put(196, "-(1+1)*4+51*4");
            put(195, "(1-14)*5*(1-4)");
            put(192, "(1+1)*4*(5+1)*4");
            put(191, "1-14+51*4");
            put(190, "1*-14+51*4");
            put(189, "-11-4+51*4");
            put(188, "1-1-(4-51)*4");
            put(187, "1/-1+4*(51-4)");
            put(186, "1+1+(45+1)*4");
            put(185, "1-1*-(45+1)*4");
            put(184, "114+5*14");
            put(183, "-1+1*(45+1)*4");
            put(182, "1+1+45/1*4");
            put(181, "1+1*45*1*4");
            put(180, "1*1*45*1*4");
            put(179, "-1/1+45*1*4");
            put(178, "-1-1+45*1*4");
            put(177, "1+1*(45-1)*4");
            put(176, "1*1*(45-1)*4");
            put(175, "-1+1*(45-1)*4");
            put(174, "-1-1+(45-1)*4");
            put(172, "11*4*(5-1)-4");
            put(171, "114*(5+1)/4");
            put(170, "(11-45)*-(1+4)");
            put(169, "114+51+4");
            put(168, "(11+45)*-(1-4)");
            put(165, "11*-45/(1-4)");
            put(161, "114+51-4");
            put(160, "1+145+14");
            put(159, "1*145+14");
            put(158, "-1+145+14");
            put(157, "1*(1-4)*-51+4");
            put(154, "11*(4-5)*-14");
            put(152, "(1+1)*4*(5+14)");
            put(151, "1+145+1+4");
            put(150, "1+145*1+4");
            put(149, "1*145*1+4");
            put(148, "1*145-1+4");
            put(147, "-1+145-1+4");
            put(146, "11+45*-(1-4)");
            put(143, "1+145+1-4");
            put(142, "1+145*1-4");
            put(141, "1+145-1-4");
            put(140, "1*145-1-4");
            put(139, "-1+145-1-4");
            put(138, "-1*(1+45)*(1-4)");
            put(137, "1+1-45*(1-4)");
            put(136, "1*1-45*(1-4)");
            put(135, "-1/1*45*(1-4)");
            put(134, "114+5/1*4");
            put(133, "114+5+14");
            put(132, "1+145-14");
            put(131, "1*145-14");
            put(130, "-1+145-14");
            put(129, "114+5*-(1-4)");
            put(128, "1+1+(4+5)*14");
            put(127, "1-14*(5-14)");
            put(126, "1*(14-5)*14");
            put(125, "-1-14*(5-14)");
            put(124, "114+5+1+4");
            put(123, "114-5+14");
            put(122, "114+5-1+4");
            put(121, "11*(45-1)/4");
            put(120, "-(1+1)*4*5*(1-4)");
            put(118, "(1+1)*(45+14)");
            put(117, "(1-14)*(5-14)");
            put(116, "114+5+1-4");
            put(115, "114+5*1-4");
            put(114, "11*4+5*14");
            put(113, "114-5/1+4");
            put(112, "114-5-1+4");
            put(111, "11+4*5*(1+4)");
            put(110, "-(11-451)/4");
            put(107, "11-4*-(5+1)*4");
            put(106, "114-5+1-4");
            put(105, "114+5-14");
            put(104, "114-5-1-4");
            put(103, "11*(4+5)+1*4");
            put(102, "11*(4+5)-1+4");
            put(101, "1+1*4*5*(1+4)");
            put(100, "1*(1+4)*5*1*4");
            put(99, "11*4+51+4");
            put(98, "1+1+4*(5+1)*4");
            put(97, "1+1*4*(5+1)*4");
            put(96, "11*(4+5)+1-4");
            put(95, "114-5-14");
            put(94, "114-5/1*4");
            put(93, "(1+1)*45-1+4");
            put(92, "(1+1)*(45-1)+4");
            put(91, "11*4+51-4");
            put(90, "-114+51*4");
            put(89, "(1+14)*5+14");
            put(88, "1*14*(5+1)+4");
            put(87, "11+4*(5+14)");
            put(86, "(1+1)*45*1-4");
            put(85, "1+14+5*14");
            put(84, "1*14+5*14");
            put(83, "-1+14+5*14");
            put(82, "1+1+4*5/1*4");
            put(81, "1/1+4*5*1*4");
            put(80, "1-1+4*5*1*4");
            put(79, "1*-1+4*5/1*4");
            put(78, "(1+1)*4+5*14");
            put(77, "11-4+5*14");
            put(76, "1+1+4+5*14");
            put(75, "1+14*5*1+4");
            put(74, "1/1*4+5*14");
            put(73, "1*14*5-1+4");
            put(72, "-1-1+4+5*14");
            put(71, "(1+14)*5-1*4");
            put(70, "11+45+14");
            put(69, "1*14+51+4");
            put(68, "1+1-4+5*14");
            put(67, "1-1*4+5*14");
            put(66, "1*14*5-1*4");
            put(65, "1*14*5-1-4");
            put(64, "11*4+5*1*4");
            put(63, "11*4+5+14");
            put(62, "1+14+51-4");
            put(61, "1+1+45+14");
            put(60, "11+45*1+4");
            put(59, "114-51-4");
            put(58, "-1+1*45+14");
            put(57, "1+14*5-14");
            put(56, "1*14*5-14");
            put(55, "-1+14*5-14");
            put(54, "11-4+51-4");
            put(53, "11+45+1-4");
            put(52, "11+45/1-4");
            put(51, "11+45-1-4");
            put(50, "1+1*45/1+4");
            put(49, "1*1*45/1+4");
            put(48, "-11+45+14");
            put(47, "1/-1+45-1+4");
            put(46, "11*4+5+1-4");
            put(45, "11+4*5+14");
            put(44, "114-5*14");
            put(43, "1+1*45+1-4");
            put(42, "11+45-14");
            put(41, "1/1*45*1-4");
            put(40, "-11+4*51/4");
            put(39, "-11+45+1+4");
            put(38, "-11+45*1+4");
            put(37, "-11+45-1+4");
            put(36, "11+4*5+1+4");
            put(35, "11*4+5-14");
            put(34, "1-14+51-4");
            put(33, "1+1+45-14");
            put(32, "1*1+45-14");
            put(31, "1/1*45-14");
            put(30, "1*-1+45-14");
            put(29, "-11+45-1-4");
            put(28, "11+4*5+1-4");
            put(27, "11+4*5/1-4");
            put(26, "11-4+5+14");
            put(25, "11*4-5-14");
            put(24, "1+14-5+14");
            put(23, "1*14-5+14");
            put(22, "1*14+5-1+4");
            put(21, "-1-1+4+5+14");
            put(20, "-11+45-14");
            put(19, "1+1+4*5+1-4");
            put(18, "1+1+4*5*1-4");
            put(17, "11+4*5-14");
            put(16, "11-4-5+14");
            put(15, "1+14-5+1+4");
            put(14, "11+4-5/1+4");
            put(13, "1*14-5/1+4");
            put(12, "-11+4+5+14");
            put(11, "11*-4+51+4");
            put(10, "-11/4+51/4");
            put(9, "11-4+5+1-4");
            put(8, "11-4+5/1-4");
            put(7, "11-4+5-1-4");
            put(6, "1-14+5+14");
            put(5, "11-4*5+14");
            put(4, "-11-4+5+14");
            put(3, "11*-4+51-4");
            put(2, "-11+4-5+14");
            put(1, "11/(45-1)*4");
            //        put(0, "(1-1)*4514");
        }
    };
}
